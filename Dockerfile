FROM alpine:3.7 as builder
COPY kibana /kibana
RUN apk add --no-cache zip
RUN zip -r /tigera_customization.zip kibana

FROM docker.elastic.co/kibana/kibana:6.4.3

# custom favicons
COPY favicons/* /usr/share/kibana/src/ui/public/assets/favicons/

# custom throbber
RUN sed -i 's/image\/svg+xml.*");/image\/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48c3ZnIHZlcnNpb249IjEuMSIgaWQ9IkxheWVyXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4IiB2aWV3Qm94PSIwIDAgMjM5LjYgMjM5LjYiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDIzOS42IDIzOS42OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PHN0eWxlIHR5cGU9InRleHQvY3NzIj4uc3Qwe2ZpbGw6I0ZGOUUxNjt9PC9zdHlsZT48cGF0aCBjbGFzcz0ic3QwIiBkPSJNMjI2LDEzMy42Yy00LjIsNS4zLTkuNiw5LjctMTUuNiwxMi44YzMuMi00LjEsNC41LTkuMSw0LjQtMTQuN2MtMjAuNCwwLTM2LjUsMTMuMy0yOC45LDM5YzQuMy0wLjMsNi44LTMuMyw5LjEtNi41YzAuMiwzLjctMC43LDcuNy0zLjUsMTIuNGwxLjgsNC4yYy01LjMsMy44LTEzLDExLTE5LjIsOC45Yy0xNi41LTE5LjMtNDIuMi0yNC42LTc1LjktNGMyLjQtNS45LDQtMTAuMyw5LjMtMTVjLTYuMi0wLjItMTcuOCwxLjQtMjYuOCw2LjRjMC4yLTI0LjcsNC00OS4zLDExLjMtNzIuOWMtMTYsMjcuNi0yMy44LDU5LjgtMzEuOCw5OC42Yy04LjUtMzYuNy0xNC45LTYyLjQtOS4xLTEwNC40Yy0xNywzLTM2LDE0LjMtNTEuMSwyMy44YzE4LjItMjQuMiw1Ny40LTUwLjIsNzQuNS01NS4yQzY2LjIsODAuNCw2MC45LDk5LDU5LjcsMTE0LjJsNy43LTAuN2MtMy4xLDYuOC02LjMsMjIuNS02LjMsMzUuN2MyLjMtMTQsOS4zLTMyLjYsMTYuNC00NC4zbC05LjQsMC44YzUuMy0xOC45LDE4LTM3LjUsMjktNDMuOGM0LjgtMS41LDkuNy0yLjIsMTQuNy0xLjljLTEuMyw3LjktNy43LDQ4LjEtNC41LDY2LjdjMC4xLTE5LjksOS42LTc1LjYsMTcuMy04OS45YzEyLjMsMTAuOSwxNC40LDE1LjksMTksMjUuNmMyNC4zLDEuMyw0My4yLDEyLjgsNjAuOSwyNi40Yy0wLjQsMS40LTEuNCwyLjUtMi44LDMuMWM0LjcsMS43LDE2LjMsOC4zLDIwLjgsMTIuMWM1LjksNSwxMy40LDExLjYsMTcuMSwxNmwtNywxMWwtMy4yLTkuNWw2LjQtMS4xbC04LjUtMC4xbDMuNSwxMS42TDIyNiwxMzMuNnogTTE5MS43LDEwNC4zbC02LjUtOC4yTDE2Ny42LDkxbDEwLjMsOC41bDYuMS0wLjNMMTkxLjcsMTA0LjN6Ii8+PC9zdmc+");/g' /usr/share/kibana/src/ui/ui_render/views/ui_app.jade /usr/share/kibana/src/ui/ui_render/views/chrome.jade

# custom plugin css
COPY --from=builder /tigera_customization.zip /
RUN sed -i "s/commons.style.css'),/commons.style.css'),createAnchor('{{bundlePath}}\/tigera_customization.style.css'),/g" /usr/share/kibana/src/ui/ui_render/bootstrap/template.js.hbs
RUN bin/kibana-plugin install file:///tigera_customization.zip
