- name: selinux
  run:
    when: "${FORCE_RUN} or change_in(['/selinux/'], {exclude: ['/**/.gitignore', '/**/README.md', '/**/LICENSE'], branch_range: '${SEMAPHORE_GIT_COMMIT_RANGE}'})"
  dependencies:
    - Prerequisites
  task:
    secrets:
      - name: google-service-account-for-gce
    prologue:
      commands:
        - cd selinux
        - export GOOGLE_APPLICATION_CREDENTIALS=$HOME/secrets/secret.google-service-account-key.json
        - export REPO_NAME=$(basename $(pwd))
        - export SHORT_WORKFLOW_ID=$(echo ${SEMAPHORE_WORKFLOW_ID} | sha256sum | cut -c -8)
        - export VM_PREFIX=sem-${SEMAPHORE_PROJECT_NAME}-${SHORT_WORKFLOW_ID}-selinux
        - export ZONE=us-east4-c
        - echo VM_PREFIX=${VM_PREFIX}
    jobs:
      - name: SELinux FV tests
        commands:
          - make ci
    epilogue:
      always:
        commands:
          - ../.semaphore/vms/clean-up-vms ${ZONE} ${VM_PREFIX}
