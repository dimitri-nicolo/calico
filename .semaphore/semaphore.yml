version: v1.0
name: node-private
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

execution_time_limit:
  minutes: 120

global_job_config:
  secrets:
    - name: docker-hub
    # Mount the github SSH secret for pulling private repositories.
    - name: private-repo
    # Mount a secret for pulling images from GCR.
    - name: tigera-dev-ci-pull-credentials
    - name: google-service-account-for-gcr
    - name: test-customer-license
  prologue:
    commands:
      # make some room on the disk
      - sudo rm -rf ~/.kiex ~/.phpbrew ~/.rbenv ~/.nvm ~/.kerl
      # Semaphore mounts a copy-on-write FS as /var/lib/docker in order to provide a pre-loaded cache of
      # some images. However, the cache is not useful to us and the copy-on-write FS is a big problem given
      # how much we churn docker containers during the build.  Disable it.
      - sudo systemctl stop docker
      - sudo umount /var/lib/docker && sudo killall qemu-nbd || true
      - sudo systemctl start docker
      # Login to Docker hub.
      - echo $DOCKERHUB_PASSWORD | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
      # Correct permissions since they are too open by default:
      - chmod 0600 ~/.keys/*
      # Add the key to the ssh agent:
      - ssh-add ~/.keys/*
      # Login to docker in order to pull images.
      - docker login --username casey@tigera.io -u _json_key -p "$(cat /home/semaphore/tigera-dev-ci.json)" https://gcr.io
      - checkout
      # Semaphore is doing shallow clone on a commit without tags.
      # unshallow it for GIT_VERSION:=$(shell git describe --tags --dirty --always) @ Makefile.common
      - git fetch --unshallow

blocks:
  - name: "Tests"
    dependencies: []
    task:
      secrets:
        # Mount the github SSH secret for pulling private repositories.
        - name: private-repo
        # Mount a secret for pulling images from GCR.
        - name: tigera-dev-ci-pull-credentials
      prologue:
        commands:
          # Correct permissions since they are too open by default:
          - chmod 0600 ~/.keys/*
          # Add the key to the ssh agent:
          - ssh-add ~/.keys/*
          # Login to docker in order to pull images.
          - docker login --username casey@tigera.io -u _json_key -p "$(cat /home/semaphore/tigera-dev-ci.json)" https://gcr.io
          - checkout
          # Semaphore is doing shallow clone on a commit without tags.
          # unshallow it for GIT_VERSION:=$(shell git describe --tags --dirty --always) @ Makefile.common
          - git fetch --unshallow
          - make mod-download
      jobs:
      - name: "Static Checks / UT and FV tests"
        commands:
          - make static-checks
          - make ut
          - make fv

  - name: "System Tests"
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu1804
      secrets:
        # Mount the github SSH secret for pulling private repositories.
        - name: private-repo
        # Mount a secret for pulling images from GCR.
        - name: tigera-dev-ci-pull-credentials
      prologue:
        commands:
          # Correct permissions since they are too open by default:
          - chmod 0600 ~/.keys/*
          # Add the key to the ssh agent:
          - ssh-add ~/.keys/*
          # Login to docker in order to pull images.
          - docker login --username casey@tigera.io -u _json_key -p "$(cat /home/semaphore/tigera-dev-ci.json)" https://gcr.io
          - checkout
          # Semaphore is doing shallow clone on a commit without tags.
          # unshallow it for GIT_VERSION:=$(shell git describe --tags --dirty --always) @ Makefile.common
          - git fetch --unshallow
          - make mod-download
      jobs:
        - name: "BGP Tests"
          commands:
            - ST_TO_RUN=tests/st/bgp/ make st
        - name: "CalicoCtl Tests"
          commands:
            - ST_TO_RUN=tests/st/calicoctl/ make st
#        Config tests don't seem to work and seem like they were never run
#        - name: "Config Tests"
#          commands:
#            - ST_TO_RUN=tests/st/config/ make st
        - name: "Enterprise Tests"
          commands:
            - ST_TO_RUN=tests/st/enterprise/ make st
        - name: "IPAM Tests"
          commands:
            - ST_TO_RUN=tests/st/ipam/ make st
        - name: "Policy Tests"
          commands:
            - ST_TO_RUN=tests/st/policy/ make st
        - name: "Utils Tests"
          commands:
            - ST_TO_RUN=tests/st/utils/ make st
        - name: "Early Networking Tests"
          commands:
            - ST_TO_RUN=tests/st/early/ make st

  - name: "Specialized Tests"
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-4
          os_image: ubuntu1804
      secrets:
        # Mount the github SSH secret for pulling private repositories.
        - name: private-repo
        # Mount a secret for pulling images from GCR.
        - name: tigera-dev-ci-pull-credentials
      prologue:
        commands:
          # Correct permissions since they are too open by default:
          - chmod 0600 ~/.keys/*
          # Add the key to the ssh agent:
          - ssh-add ~/.keys/*
          # Login to docker in order to pull images.
          - docker login --username casey@tigera.io -u _json_key -p "$(cat /home/semaphore/tigera-dev-ci.json)" https://gcr.io
          - checkout
          # Semaphore is doing shallow clone on a commit without tags.
          # unshallow it for GIT_VERSION:=$(shell git describe --tags --dirty --always) @ Makefile.common
          - git fetch --unshallow
      jobs:
        - name: "Dual Stack Tests"
          commands:
            - make k8s-test
        - name: "Vanilla Tests"
          commands:
            - make k8s-test K8ST_RIG=vanilla
        - name: "Dual Tor Tests"
          commands:
            - make dual-tor-test

  # Build Windows zip files.
  # We'll only do this on PR builds, non-PR builds would run make push-windows-archive-gcs.
  - name: "Build Windows installation zip file (PR builds only)"
    dependencies: []
    task:
      prologue:
        commands:
          - checkout
          # Semaphore is doing shallow clone on a commit without tags.
          # unshallow it for GIT_VERSION:=$(shell git describe --tags --dirty --always) @ Makefile.common
          - git fetch --unshallow
      jobs:
      - name: "build Windows archive"
        commands:
        - if [ ! -z "${SEMAPHORE_GIT_PR_NUMBER}" ]; then make build-windows-archive; fi

  # If tests passed, then build and push images.
  # We'll only do this on non-PR builds, where we have credentials to do so.
  - name: "Push images and Windows installation zip file (non-PR builds only)"
    dependencies: ["Tests", "System Tests", "Specialized Tests"]
    task:
      secrets:
        # Mount a secret for pulling images from GCR.
        - name: google-service-account-for-gcr
        # Mount a secret so we can push Windows zip files to GCS.
        - name: gcp-registry-pusher-service-account
      prologue:
        commands:
          # Correct permissions since they are too open by default:
          - chmod 0600 ~/.keys/*
          # Add the key to the ssh agent:
          - ssh-add ~/.keys/*
          # Login to docker in order to pull images.
          - docker login --username casey@tigera.io -u _json_key -p "$(cat ~/secrets/secret.google-service-account-key.json)" https://gcr.io
          - checkout
          # Semaphore is doing shallow clone on a commit without tags.
          # unshallow it for GIT_VERSION:=$(shell git describe --tags --dirty --always) @ Makefile.common
          - git fetch --unshallow
      jobs:
      - name: "make cd"
        commands:
        - export BRANCH_NAME=$SEMAPHORE_GIT_BRANCH
        - if [ -z "${SEMAPHORE_GIT_PR_NUMBER}" ]; then make image-all cd CONFIRM=true; fi
      - name: "make windows"
        commands:
        - |
          if [ -z "${SEMAPHORE_GIT_PR_NUMBER}" ]; then
            make push-windows-archive-gcs
            artifact push workflow ${WINDOWS_ZIP_WILDCARD} --expire-in ${SEMAPHORE_ARTIFACT_EXPIRY} || true
          fi
        env_vars:
          - name: SEMAPHORE_ARTIFACT_EXPIRY
            value: 1w
          - name: WINDOWS_ZIP_WILDCARD
            value: "./dist/tigera-calico-windows*.zip"

promotions:
  # Run the pin update process in case there were a backlog of pin update requests
  - name: Update Pins
    pipeline_file: update_pins.yml
    auto_promote:
      # If the block has passed and the branch is for master or a release branch then run the pin updates. Note that
      # this doesn't try to restrict which release branches, as the presence of this auto promotion code means that
      # it can handle updating the pins in this fashion.
      when: "(result = 'passed') and ((branch = 'master') or (branch =~ '^release-calient-v\d*\.\d*'))"
