version: v1.0
name: Felix
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2004

execution_time_limit:
  minutes: 10

global_job_config:
  secrets:
  - name: docker-hub
  prologue:
    commands:
    - echo $DOCKERHUB_PASSWORD | docker login --username "$DOCKERHUB_USERNAME" --password-stdin

blocks:
- name: Clean up GCE resources
  dependencies: []
  task:
    prologue:
      commands:
      - checkout
      # The following settings all need to match the corresponding ones in semaphore.yml,
      # in the places that launch the VMs (for UT or FV testing).
      - export GOOGLE_APPLICATION_CREDENTIALS=$HOME/secrets/secret.google-service-account-key.json
      - export SHORT_WORKFLOW_ID=$(echo ${SEMAPHORE_WORKFLOW_ID} | sha256sum | cut -c -8)
      - export ZONE=us-east4-c
      - export VM_PREFIX=sem-${SEMAPHORE_PROJECT_NAME}-${SHORT_WORKFLOW_ID}
      - echo VM_PREFIX=${VM_PREFIX}
    jobs:
    - name: Clean up GCE instances
      commands:
      - ./.semaphore/clean-up-vms ${VM_PREFIX}
    secrets:
    - name: google-service-account-for-gce

- name: Clean up winfv aws resources
  dependencies: []
  task:
    prologue:
      commands:
      # Prepare aws configuration.
      - pip install --upgrade --user awscli
      # Load the github access secrets.  First fix the permissions.
      - chmod 0600 ~/.keys/*
      - ssh-add ~/.keys/*
      - export SHORT_WORKFLOW_ID=$(echo ${SEMAPHORE_WORKFLOW_ID} | sha256sum | cut -c -8)
      - export CLUSTER_NAME=sem-${SEMAPHORE_PROJECT_NAME}-pr${SEMAPHORE_GIT_PR_NUMBER}-${WINDOWS_VERSION}-${BACKEND}-${SHORT_WORKFLOW_ID}
      - export KEYPAIR_NAME=${CLUSTER_NAME}
      - echo CLUSTER_NAME=${CLUSTER_NAME}
    jobs:
    - name: Clean up winfv aws resources
      commands:
      - retry git clone git@github.com:tigera/process.git
      - aws ec2 delete-key-pair --key-name ${KEYPAIR_NAME} || true
      - cd process/testing/winfv && NAME_PREFIX="${CLUSTER_NAME}" ./setup-fv.sh -q -u
      matrix:
        - env_var: WINDOWS_VERSION
          values: ["2004", "20H2"]
        - env_var: BACKEND
          values: ["bgp"]
      env_vars:
      - name: AWS_DEFAULT_REGION
        value: us-west-2
    secrets:
    - name: private-repo
