# Copyright (c) 2024 Tigera, Inc. All rights reserved.

Name: calico-fluent-bit
Version: @VERSION@
Release: @RELEASE@%{?dist}
Summary: Fluent Bit is a super fast, lightweight, and highly scalable logging and metrics processor and forwarder.
License: Apache-2.0
URL: https://www.tigera.io/
Source0: https://github.com/fluent/fluent-bit/archive/refs/tags/v%{version}.tar.gz
Source1: calico-fluent-bit.conf
Source2: calico-fluent-bit.env
Source3: plugins.conf
Source4: record_transformer.lua
Source5: out_linseed.so
Source6: calico-fluent-bit.service

Patch0: 0001-Rename-Fluent-Bit-package-name-to-Calico-Fluent-Bit.patch
Patch1: 0002-Move-config-files-to-etc-calico-calico-fluent-bit.patch
Patch2: 0003-Pass-output-plugin-tls-config-to-properties.patch

BuildRequires: bison
BuildRequires: cmake
BuildRequires: flex
BuildRequires: gcc-c++
BuildRequires: libyaml-devel
BuildRequires: make
BuildRequires: openssl-devel
BuildRequires: pkgconfig
BuildRequires: zlib-devel

Requires: libyaml

%description

Fluent Bit is a fast Log Processor and Forwarder for Linux, Embedded Linux, MacOS and BSD
family operating systems. It's part of the Fluentd Ecosystem and a CNCF sub-project.

%prep
%autosetup -p1

%build
%cmake \
    -DCMAKE_BUILD_TYPE=RelWithDebInfo \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_INSTALL_SYSCONFDIR=/etc \
    -DFLB_DEBUG=Off \
    -DFLB_EXAMPLES=Off \
    -DFLB_FILTER_LUA=On \
    -DFLB_FILTER_RECORD_MODIFIER=On \
    -DFLB_IN_STORAGE_BACKLOG=On \
    -DFLB_IN_TAIL=On \
    -DFLB_LUAJIT=On \
    -DFLB_MINIMAL=On \
    -DFLB_PROXY_GO=On \
    -DFLB_RELEASE=On \
    -DFLB_SHARED_LIB=Off \
    -DFLB_SQLDB=On \
    -DFLB_TESTS_INTERNAL=Off \
    -DFLB_TESTS_RUNTIME=Off \
    -DFLB_TLS=On \
    -DFLB_WASM=Off
%cmake_build

%install
# install vendor defaults
%cmake_install
# overwrite with Tigera customizations
install -m 644 %{SOURCE1} %{buildroot}%{_sysconfdir}/calico/%{name}
install -m 644 %{SOURCE2} %{buildroot}%{_sysconfdir}/calico/%{name}
install -m 644 %{SOURCE3} %{buildroot}%{_sysconfdir}/calico/%{name}
install -m 644 %{SOURCE4} %{buildroot}%{_sysconfdir}/calico/%{name}
install -m 644 %{SOURCE5} %{buildroot}%{_sysconfdir}/calico/%{name}
install -m 644 %{SOURCE6} %{buildroot}%{_unitdir}/%{name}.service
# filesystem buffer
install -d %{buildroot}%{_localstatedir}/log/calico/%{name}

install -m 770 -d %{buildroot}%{_rundir}/calico

rm -rvf %{buildroot}%{_includedir}

%check
%ctest

%pre
/usr/sbin/groupadd -r calico >/dev/null 2>&1 || :
/usr/sbin/useradd -M -d /var/lib/calico -g calico -r -s /sbin/nologin -c "Calico user" calico >/dev/null 2>&1 || :

%preun
%systemd_preun %{name}.service

%postun
%systemd_postun_with_restart %{name}.service

%files
%config %{_sysconfdir}/calico/%{name}/*.conf
%config(noreplace) %{_sysconfdir}/calico/%{name}/*.env
%attr(0755,calico,calico) %dir %{_localstatedir}/log/calico/%{name}
%attr(0770,root,calico) %dir %{_rundir}/calico
%dir %{_sysconfdir}/calico/%{name}
%{_bindir}/%{name}
%{_sysconfdir}/calico/%{name}/out_linseed.so
%{_sysconfdir}/calico/%{name}/record_transformer.lua
%{_unitdir}/%{name}.service

%exclude /usr/bin/luajit
%exclude /usr/lib64/libluajit.a

%changelog
* Wed Sep 25 2024 Jiawei Huang <jiawei@tigera.io> - 3.1.8-1
- Update version to 3.1.8

* Wed Sep 4 2024 Jiawei Huang <jiawei@tigera.io> - 3.1.7-1
- Update version to 3.1.7

* Mon Aug 19 2024 Jiawei Huang <jiawei@tigera.io> - 3.1.6-1
- Update version to 3.1.6

* Sun Aug 11 2024 Jiawei Huang <jiawei@tigera.io> - 3.1.5-1
- Initial Calico Fluent Bit package
